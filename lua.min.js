(()=>{if(document.getElementById("luascript-hide-style"))return;const t=document.createElement("style");t.id="luascript-hide-style",t.textContent='\n    lua-script,\n    script[type="lua"] {\n      display: none !important;\n    }\n  ',(document.head||document.documentElement).appendChild(t);try{document.querySelectorAll("lua-script, script[type='lua']").forEach(t=>{t.hidden=!0})}catch{}})(),(()=>{try{document.querySelectorAll("lua-script, script[type='lua']").forEach(t=>{t.hidden=!0})}catch{}async function t(t){const e=await fetch(t);if(!e.ok)throw new Error(`${t} (${e.status})`);return e.text()}function e(t){const e=document.createElement("pre");return t.insertAdjacentElement("afterend",e),t=>{e.textContent+=t+"\n"}}async function n(){var n;await(n="https://unpkg.com/fengari-web/dist/fengari-web.js",new Promise((t,e)=>{if([...document.scripts].some(t=>t.src===n))return t();const r=document.createElement("script");r.src=n,r.onload=t,r.onerror=()=>e(new Error("Failed to load "+n)),document.head.appendChild(r)}));const{lua:r,lauxlib:a,lualib:o,to_luastring:u,to_jsstring:l}=window.fengari,s=a.luaL_newstate();o.luaL_openlibs(s);let c=()=>{},i=!1;const d="true"===document.currentScript?.getAttribute("debug");function p(t){i&&c("[LuaDebug] "+t)}r.lua_getglobal(s,u("debug")),r.lua_getfield(s,-1,u("traceback")),r.lua_remove(s,-2);const _=a.luaL_ref(s,r.LUA_REGISTRYINDEX);function h(t,e){const n=r.lua_gettop(s)-t;r.lua_rawgeti(s,r.LUA_REGISTRYINDEX,_),r.lua_insert(s,n);const a=r.lua_pcall(s,t,e,n);return r.lua_remove(s,n),a}function g(t){if(!i)return void r.lua_pop(s,1);const e=function(t){a.luaL_tolstring(s,t);const e=r.lua_tostring(s,-1),n=e?l(e):"";return r.lua_pop(s,1),n}(-1);r.lua_pop(s,1),c(`[LuaError] ${t}: ${e}`)}function f(t){null!=t?"number"!=typeof t?"boolean"!=typeof t?r.lua_pushstring(s,u(String(t))):r.lua_pushboolean(s,t?1:0):r.lua_pushnumber(s,t):r.lua_pushnil(s)}function m(t,...e){if(r.lua_getglobal(s,u(t)),!r.lua_isfunction(s,-1))return r.lua_pop(s,1),void p(`callback not found: ${t}`);for(const t of e)f(t);h(e.length,0)!==r.LUA_OK&&g("callback")}function b(t,...e){if(r.lua_rawgeti(s,r.LUA_REGISTRYINDEX,t),!r.lua_isfunction(s,-1))return r.lua_pop(s,1),void p(`callback ref not a function: ${t}`);for(const t of e)f(t);h(e.length,0)!==r.LUA_OK&&g("callback")}function y(t,e){r.lua_getglobal(s,u("package")),r.lua_getfield(s,-1,u("preload")),r.lua_pushstring(s,u(e)),r.lua_pushcclosure(s,function(t){const e=r.lua_tostring(t,r.lua_upvalueindex(1)),n=e?l(e):"";return a.luaL_loadstring(t,u(n))!==r.LUA_OK||r.lua_pcall(t,0,r.LUA_MULTRET,0)!==r.LUA_OK?r.lua_error(t):0===r.lua_gettop(t)?(r.lua_pushboolean(t,1),1):1},1),r.lua_setfield(s,-2,u(t)),r.lua_pop(s,2)}function L(t,e){try{return new URL(t,e).href}catch{return t}}r.lua_pushcfunction(s,function(t){const e=r.lua_gettop(t),n=[];for(let o=1;o<=e;o++){a.luaL_tolstring(t,o);const e=r.lua_tostring(t,-1);n.push(e?l(e):""),r.lua_pop(t,1)}return c(n.join("\t")),0}),r.lua_setglobal(s,u("print"));const w=new Set;async function S(e){if(!e)return;const n=L(e,window.location.href);if(w.has(n))return;const r=await t(n),a=JSON.parse(r);if(a?.modules)for(const[e,r]of Object.entries(a.modules)){const a=L(r,n);y(e,await t(a)),p(`config module loaded: ${e} <- ${a}`)}w.add(n)}const v=new Map,E=new Set;function U(t,e){r.lua_getglobal(s,u("__LS_BRIDGE")),r.lua_pushcfunction(s,e),r.lua_setfield(s,-2,u(t)),r.lua_pop(s,1)}function A(t){const e=r.lua_tostring(s,t);return e?l(e):""}function I(t){if(r.lua_type(s,t)===r.LUA_TFUNCTION){r.lua_pushvalue(s,t);return{kind:"ref",value:a.luaL_ref(s,r.LUA_REGISTRYINDEX)}}const e=r.lua_tostring(s,t);return{kind:"name",value:e?l(e):""}}function R(t,...e){t&&("name"===t.kind?m(t.value,...e):b(t.value,...e))}function k(t){return document.querySelector(t)}r.lua_newtable(s),r.lua_setglobal(s,u("__LS_BRIDGE")),U("display",t=>{const e=r.lua_gettop(t),n=[];for(let o=1;o<=e;o++){a.luaL_tolstring(t,o);const e=r.lua_tostring(t,-1);n.push(e?l(e):""),r.lua_pop(t,1)}return c(n.join(" ")),0}),U("text",t=>{const e=k(A(1));return e?r.lua_gettop(t)>=2?(e.textContent=A(2),0):(r.lua_pushstring(t,u(e.textContent??"")),1):(r.lua_pushnil(t),1)}),U("html",t=>{const e=k(A(1));return e?r.lua_gettop(t)>=2?(e.innerHTML=A(2),0):(r.lua_pushstring(t,u(e.innerHTML??"")),1):(r.lua_pushnil(t),1)}),U("attr",t=>{const e=A(1),n=A(2),a=k(e);return a?r.lua_gettop(t)>=3?(a.setAttribute(n,A(3)),0):(r.lua_pushstring(t,u(a.getAttribute(n)??"")),1):(r.lua_pushnil(t),1)}),U("addClass",t=>{const e=k(A(1));return e&&e.classList.add(A(2)),0}),U("removeClass",t=>{const e=k(A(1));return e&&e.classList.remove(A(2)),0}),U("toggleClass",t=>{const e=k(A(1));return e&&e.classList.toggle(A(2)),0}),U("when",t=>{const e=A(1),n=A(2),r=I(3),a=`${e}|${n}`;var o;return v.has(a)||v.set(a,[]),v.get(a).push(r),o=e,E.has(o)||(E.add(o),document.addEventListener(o,t=>{for(const[e,n]of v.entries()){const r=e.indexOf("|"),a=e.slice(0,r),u=e.slice(r+1);if(a!==o)continue;const l=t.target?.closest?t.target.closest(u):null;if(!l)continue;const s=[t.type,u,l.id||"","string"==typeof l.className?l.className:""];for(const t of n)"name"===t.kind?m(t.value,...s):b(t.value,...s)}},!0),p(`bound DOM event: ${o}`)),0}),U("http_get",t=>{const e=A(1),n=I(2);return fetch(e).then(async t=>{const e=await t.text();R(n,t.status,e)}).catch(t=>{R(n,0,String(t))}),0});const x=new Map;let M=1;function O(t){return[...new Uint8Array(t)].map(t=>t.toString(16).padStart(2,"0")).join("")}U("set_timeout",t=>{const e=parseInt(A(1)||"0",10),n=I(2),a=M++,o=setTimeout(()=>{R(n),x.delete(a)},Math.max(0,e));return x.set(a,{kind:"timeout",handle:o}),r.lua_pushnumber(t,a),1}),U("set_interval",t=>{const e=parseInt(A(1)||"0",10),n=I(2),a=M++,o=setInterval(()=>{R(n)},Math.max(1,e));return x.set(a,{kind:"interval",handle:o}),r.lua_pushnumber(t,a),1}),U("clear_timer",t=>{const e=parseInt(A(1)||"0",10),n=x.get(e);return n&&("timeout"===n.kind?clearTimeout(n.handle):clearInterval(n.handle),x.delete(e)),r.lua_pushboolean(t,1),1}),U("storage_get",t=>{const e=A(1);let n=null;try{n=localStorage.getItem(e)}catch{n=null}return null==n?r.lua_pushnil(t):r.lua_pushstring(t,u(String(n))),1}),U("storage_set",t=>{const e=A(1),n=A(2);try{localStorage.setItem(e,n)}catch{}return r.lua_pushboolean(t,1),1}),U("storage_remove",t=>{const e=A(1);try{localStorage.removeItem(e)}catch{}return r.lua_pushboolean(t,1),1}),U("storage_clear",t=>{try{localStorage.clear()}catch{}return r.lua_pushboolean(t,1),1}),U("storage_keys",t=>{let e=[];try{for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);null!=n&&e.push(n)}}catch{}return r.lua_pushstring(t,u(e.join("\n"))),1}),U("crypto_random_bytes",t=>{const e=Math.max(1,Math.min(4096,parseInt(A(1)||"16",10))),n=new Uint8Array(e);return crypto.getRandomValues(n),r.lua_pushstring(t,u(O(n))),1}),U("crypto_sha256",t=>{const e=A(1),n=I(2);return crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e)).then(t=>R(n,"",O(t))).catch(t=>R(n,String(t),"")),0}),U("crypto_pbkdf2",t=>{const e=A(1),n=A(2),r=parseInt(A(3)||"100000",10),a=parseInt(A(4)||"256",10),o=I(5);return(async()=>{try{const t=await crypto.subtle.importKey("raw",(new TextEncoder).encode(e),"PBKDF2",!1,["deriveBits"]),u=await crypto.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:(new TextEncoder).encode(n),iterations:r},t,a);R(o,"",O(u))}catch(t){R(o,String(t),"")}})(),0});const C=new Map;let T=1;U("ws_connect",t=>{const e=A(1),n=I(2),a=I(3),o=I(4),u=I(5),l=T++;let s;try{s=new WebSocket(e)}catch(e){return R(u,"open_failed:"+String(e)),r.lua_pushnumber(t,0),1}return s.onopen=()=>R(n),s.onmessage=t=>R(a,String(t.data??"")),s.onclose=t=>R(o,t.code??0,String(t.reason??"")),s.onerror=()=>R(u,"ws_error"),C.set(l,s),r.lua_pushnumber(t,l),1}),U("ws_send",t=>{const e=parseInt(A(1)||"0",10),n=A(2),a=C.get(e);try{a&&a.readyState===WebSocket.OPEN&&a.send(n)}catch{}return r.lua_pushboolean(t,1),1}),U("ws_close",t=>{const e=parseInt(A(1)||"0",10),n=parseInt(A(2)||"1000",10),a=A(3),o=C.get(e);try{o&&o.close(n,a)}catch{}return C.delete(e),r.lua_pushboolean(t,1),1}),U("http_request",t=>{const e=A(1).toUpperCase()||"GET",n=A(2),r=A(3)||"{}",a=A(4)||"",o=I(5);let u={};try{u=JSON.parse(r||"{}")||{}}catch{u={}}return fetch(n,{method:e,headers:u,body:"GET"===e||"HEAD"===e?void 0:a}).then(async t=>{const e=await t.text(),n={};try{t.headers.forEach((t,e)=>n[e]=t)}catch{}R(o,t.status,e,JSON.stringify(n))}).catch(t=>{R(o,0,String(t),"{}")}),0}),U("asset_image",t=>{const e=A(1),n=I(2);return fetch(e).then(t=>t.blob()).then(t=>{const e=URL.createObjectURL(t),r=new Image;r.onload=()=>R(n,!0,r.naturalWidth||0,r.naturalHeight||0,e),r.onerror=()=>{try{URL.revokeObjectURL(e)}catch{}R(n,!1,0,0,"")},r.src=e}).catch(()=>R(n,!1,0,0,"")),0}),U("asset_audio",t=>{const e=A(1),n=I(2);return fetch(e).then(t=>t.blob()).then(t=>{const e=URL.createObjectURL(t);R(n,!0,e)}).catch(()=>R(n,!1,"")),0}),U("asset_revoke",t=>{const e=A(1);try{URL.revokeObjectURL(e)}catch{}return 0}),U("call_api",t=>{const e=A(1),n=r.lua_gettop(t),a=(window.LuaScriptAPI||{})[e];if("function"!=typeof a)return r.lua_pushnil(t),1;const o=[];for(let t=2;t<=n;t++)o.push(A(t));try{const e=a(...o);return null==e?r.lua_pushnil(t):r.lua_pushstring(t,u(String(e))),1}catch(e){return r.lua_pushstring(t,u("ERR:"+String(e))),1}});let N=null;function j(t){if(a.luaL_loadstring(s,u(t))!==r.LUA_OK)return g("syntax");h(0,r.LUA_MULTRET)!==r.LUA_OK&&g("runtime"),r.lua_settop(s,0)}U("pdf_create",t=>(N=new jspdf.jsPDF({unit:"mm",format:"a4"}),r.lua_pushboolean(t,1),1)),U("pdf_add_page",t=>N?(N.addPage(),0):0),U("pdf_text",t=>{if(!N)return 0;const e=parseFloat(A(1)),n=parseFloat(A(2)),r=A(3),a=parseFloat(A(4)||"12");return N.setFontSize(a),N.text(r,e,n),0}),U("pdf_table",t=>{if(!N)return 0;const e=parseFloat(A(1)),n=parseFloat(A(2)),r=JSON.parse(A(3)),a=JSON.parse(A(4));return N.autoTable({startY:n,head:[r],body:a,margin:{left:e}}),0}),U("pdf_save",t=>{if(!N)return 0;const e=A(1)||"output.pdf";return N.save(e),N=null,0}),U("pdf_blob_url",t=>{if(!N)return r.lua_pushnil(t),1;try{const e=N.output("blob"),n=URL.createObjectURL(e);return r.lua_pushstring(t,u(n)),1}catch(e){return r.lua_pushnil(t),1}}),U("pdf_revoke",t=>{const e=A(1);try{URL.revokeObjectURL(e)}catch{}return 0}),y("luascript","\n  local bridge = __LS_BRIDGE\n  local M = {}\n\n  function M.display(...) bridge.display(...) end\n  function M.when(eventName, selector, handler) bridge.when(eventName, selector, handler) end\n  function M.get(url, handler) bridge.http_get(url, handler) end\n\n  function M.text(selector, value) return bridge.text(selector, value) end\n  function M.html(selector, value) return bridge.html(selector, value) end\n  function M.attr(selector, name, value) return bridge.attr(selector, name, value) end\n  function M.addClass(selector, cls) return bridge.addClass(selector, cls) end\n  function M.removeClass(selector, cls) return bridge.removeClass(selector, cls) end\n  function M.toggleClass(selector, cls) return bridge.toggleClass(selector, cls) end\n\n  return M\n      ");const D=Array.from(document.querySelectorAll("lua-script, script[type='lua']"));for(const n of D){n.hidden=!0,c=e(n),i="true"===n.getAttribute("debug")||d;try{await S(n.getAttribute("config"))}catch(t){i&&c("[LuaError] config: "+t.message);continue}let r="";r="lua-script"===n.tagName.toLowerCase()?n.textContent||"":n.getAttribute("src")?await t(n.getAttribute("src")):n.textContent||"",j(r),p("LuaScript runtime finished one script node")}p("LuaScript runtime ready")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>n().catch(console.error)):n().catch(console.error)})();